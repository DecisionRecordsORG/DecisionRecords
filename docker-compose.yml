# Decision Records - Docker Compose for Self-Hosting
#
# Quick Start (SQLite):
#   docker-compose up -d
#   Open http://localhost:3000
#
# With PostgreSQL:
#   docker-compose --profile postgres up -d
#
# Configuration:
#   Copy .env.example to .env and customize values

services:
  app:
    image: ghcr.io/decisionrecordsorg/decisionrecords:latest
    # Or build locally:
    # build:
    #   context: .
    #   dockerfile: Dockerfile.community
    ports:
      - "3000:8000"
    volumes:
      - adr-data:/data
    environment:
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - DATABASE_URL=${DATABASE_URL:-sqlite:////data/architecture_decisions.db}
      - DECISION_RECORDS_EDITION=community
      - SKIP_CLOUDFLARE_CHECK=true
    depends_on:
      db:
        condition: service_started
        required: false
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Optional PostgreSQL database (use --profile postgres)
  db:
    image: postgres:15-alpine
    profiles:
      - postgres
    environment:
      - POSTGRES_USER=decisions
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=decisions
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U decisions"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Watchtower for automatic updates
  watchtower:
    image: containrrr/watchtower
    profiles:
      - auto-update
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400  # Check daily
      - WATCHTOWER_INCLUDE_STOPPED=false
    restart: unless-stopped

volumes:
  adr-data:
  postgres-data:
