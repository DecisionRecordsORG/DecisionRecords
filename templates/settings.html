{% extends "base.html" %}

{% block title %}Settings - Decision Records{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-gear"></i> Settings</h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- SSO Configuration -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-shield-lock"></i> SSO Configuration</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#ssoModal" onclick="openSSOModal()">
                    <i class="bi bi-plus"></i> Add SSO Provider
                </button>
            </div>
            <div class="card-body">
                <div id="ssoConfigsContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-envelope"></i> Email Configuration</h5>
            </div>
            <div class="card-body">
                <form id="emailConfigForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="smtpServer" class="form-label">SMTP Server</label>
                                <input type="text" class="form-control" id="smtpServer" placeholder="smtp.example.com">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="smtpPort" class="form-label">Port</label>
                                <input type="number" class="form-control" id="smtpPort" value="587">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtpUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="smtpUsername">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtpPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="smtpPassword" placeholder="Leave blank to keep existing">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fromEmail" class="form-label">From Email</label>
                                <input type="email" class="form-control" id="fromEmail" placeholder="noreply@example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fromName" class="form-label">From Name</label>
                                <input type="text" class="form-control" id="fromName" value="Decision Records">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useTls" checked>
                            <label class="form-check-label" for="useTls">Use TLS</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailEnabled" checked>
                            <label class="form-check-label" for="emailEnabled">Enable email notifications</label>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Email Configuration
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="testEmailBtn">
                            <i class="bi bi-send"></i> Send Test Email
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- User Management -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> Users</h5>
            </div>
            <div class="card-body">
                <div id="usersContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Help</h5>
            </div>
            <div class="card-body">
                <h6>SSO Configuration</h6>
                <p class="small text-muted">Configure OpenID Connect (OIDC) providers for your organization. You'll need:</p>
                <ul class="small text-muted">
                    <li>Client ID and Secret from your identity provider</li>
                    <li>Discovery URL (usually ends with <code>/.well-known/openid-configuration</code>)</li>
                </ul>

                <h6 class="mt-3">Common Discovery URLs</h6>
                <ul class="small text-muted">
                    <li><strong>Google:</strong><br><code>https://accounts.google.com/.well-known/openid-configuration</code></li>
                    <li><strong>Azure AD:</strong><br><code>https://login.microsoftonline.com/{tenant}/v2.0/.well-known/openid-configuration</code></li>
                    <li><strong>Okta:</strong><br><code>https://{domain}.okta.com/.well-known/openid-configuration</code></li>
                </ul>

                <h6 class="mt-3">Email Configuration</h6>
                <p class="small text-muted">Configure SMTP settings to enable email notifications for subscribers.</p>
            </div>
        </div>
    </div>
</div>

<!-- SSO Modal -->
<div class="modal fade" id="ssoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ssoModalTitle">Add SSO Provider</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="ssoForm">
                <div class="modal-body">
                    <input type="hidden" id="ssoId">
                    <div class="mb-3">
                        <label for="ssoDomain" class="form-label">Domain <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="ssoDomain" placeholder="company.com" required>
                        <div class="form-text">Email domain for users (e.g., company.com)</div>
                    </div>
                    <div class="mb-3">
                        <label for="ssoProviderName" class="form-label">Provider Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="ssoProviderName" placeholder="e.g., Google, Okta, Azure AD" required>
                    </div>
                    <div class="mb-3">
                        <label for="ssoClientId" class="form-label">Client ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="ssoClientId" required>
                    </div>
                    <div class="mb-3">
                        <label for="ssoClientSecret" class="form-label">Client Secret <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="ssoClientSecret">
                        <div class="form-text" id="ssoSecretHelp">Leave blank to keep existing secret when editing</div>
                    </div>
                    <div class="mb-3">
                        <label for="ssoDiscoveryUrl" class="form-label">Discovery URL <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="ssoDiscoveryUrl" placeholder="https://..." required>
                        <div class="form-text">OpenID Connect discovery URL</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="ssoEnabled" checked>
                        <label class="form-check-label" for="ssoEnabled">Enabled</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="ssoSaveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let ssoConfigs = [];
    let editingSSO = null;

    // Load SSO configs
    async function loadSSOConfigs() {
        try {
            const response = await fetch('/api/admin/sso');
            ssoConfigs = await response.json();
            renderSSOConfigs();
        } catch (error) {
            console.error('Error loading SSO configs:', error);
        }
    }

    function renderSSOConfigs() {
        const container = document.getElementById('ssoConfigsContainer');

        if (ssoConfigs.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-shield-lock display-6"></i>
                    <p class="mt-2">No SSO providers configured yet.</p>
                </div>
            `;
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover mb-0">';
        html += '<thead><tr><th>Domain</th><th>Provider</th><th>Status</th><th>Actions</th></tr></thead><tbody>';

        ssoConfigs.forEach(config => {
            html += `
                <tr>
                    <td><strong>${config.domain}</strong></td>
                    <td>${config.provider_name}</td>
                    <td>
                        <span class="badge ${config.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${config.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editSSO(${config.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSSO(${config.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    window.openSSOModal = function(config = null) {
        editingSSO = config;
        document.getElementById('ssoModalTitle').textContent = config ? 'Edit SSO Provider' : 'Add SSO Provider';
        document.getElementById('ssoId').value = config ? config.id : '';
        document.getElementById('ssoDomain').value = config ? config.domain : '';
        document.getElementById('ssoDomain').disabled = !!config;
        document.getElementById('ssoProviderName').value = config ? config.provider_name : '';
        document.getElementById('ssoClientId').value = config ? config.client_id : '';
        document.getElementById('ssoClientSecret').value = '';
        document.getElementById('ssoSecretHelp').style.display = config ? 'block' : 'none';
        document.getElementById('ssoDiscoveryUrl').value = config ? config.discovery_url : '';
        document.getElementById('ssoEnabled').checked = config ? config.enabled : true;
    };

    window.editSSO = function(id) {
        const config = ssoConfigs.find(c => c.id === id);
        if (config) {
            openSSOModal(config);
            new bootstrap.Modal(document.getElementById('ssoModal')).show();
        }
    };

    window.deleteSSO = async function(id) {
        if (!confirm('Are you sure you want to delete this SSO configuration?')) return;

        try {
            const response = await fetch(`/api/admin/sso/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadSSOConfigs();
            } else {
                alert('Failed to delete SSO configuration');
            }
        } catch (error) {
            alert('Error deleting SSO configuration');
        }
    };

    document.getElementById('ssoForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const id = document.getElementById('ssoId').value;
        const data = {
            domain: document.getElementById('ssoDomain').value,
            provider_name: document.getElementById('ssoProviderName').value,
            client_id: document.getElementById('ssoClientId').value,
            client_secret: document.getElementById('ssoClientSecret').value,
            discovery_url: document.getElementById('ssoDiscoveryUrl').value,
            enabled: document.getElementById('ssoEnabled').checked
        };

        try {
            const url = id ? `/api/admin/sso/${id}` : '/api/admin/sso';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                alert(result.error || 'Failed to save SSO configuration');
                return;
            }

            bootstrap.Modal.getInstance(document.getElementById('ssoModal')).hide();
            loadSSOConfigs();
        } catch (error) {
            alert('Error saving SSO configuration');
        }
    });

    // Load email config
    async function loadEmailConfig() {
        try {
            const response = await fetch('/api/admin/email');
            const config = await response.json();

            if (config) {
                document.getElementById('smtpServer').value = config.smtp_server || '';
                document.getElementById('smtpPort').value = config.smtp_port || 587;
                document.getElementById('smtpUsername').value = config.smtp_username || '';
                document.getElementById('fromEmail').value = config.from_email || '';
                document.getElementById('fromName').value = config.from_name || 'Decision Records';
                document.getElementById('useTls').checked = config.use_tls !== false;
                document.getElementById('emailEnabled').checked = config.enabled !== false;
            }
        } catch (error) {
            console.error('Error loading email config:', error);
        }
    }

    document.getElementById('emailConfigForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const data = {
            smtp_server: document.getElementById('smtpServer').value,
            smtp_port: parseInt(document.getElementById('smtpPort').value),
            smtp_username: document.getElementById('smtpUsername').value,
            smtp_password: document.getElementById('smtpPassword').value,
            from_email: document.getElementById('fromEmail').value,
            from_name: document.getElementById('fromName').value,
            use_tls: document.getElementById('useTls').checked,
            enabled: document.getElementById('emailEnabled').checked
        };

        try {
            const response = await fetch('/api/admin/email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                alert(result.error || 'Failed to save email configuration');
                return;
            }

            alert('Email configuration saved successfully');
            document.getElementById('smtpPassword').value = '';
        } catch (error) {
            alert('Error saving email configuration');
        }
    });

    document.getElementById('testEmailBtn').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/admin/email/test', { method: 'POST' });
            const result = await response.json();

            if (response.ok) {
                alert('Test email sent successfully!');
            } else {
                alert(result.error || 'Failed to send test email');
            }
        } catch (error) {
            alert('Error sending test email');
        }
    });

    // Load users
    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            const users = await response.json();
            renderUsers(users);
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function renderUsers(users) {
        const container = document.getElementById('usersContainer');

        if (users.length === 0) {
            container.innerHTML = '<p class="text-muted">No users found.</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover mb-0">';
        html += '<thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Last Login</th></tr></thead><tbody>';

        users.forEach(user => {
            html += `
                <tr>
                    <td>${user.name || '-'}</td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge ${user.is_admin ? 'bg-primary' : 'bg-secondary'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    loadSSOConfigs();
    loadEmailConfig();
    loadUsers();
});
</script>
{% endblock %}
